# OPC UA Smart Reader & Writer v2.1

–ú–æ–¥—É–ª—å–Ω–∏–π –ø–∞–∫–µ—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ OPC UA –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º —Ç–∏–ø—ñ–≤. –®–≤–∏–¥–∫—ñ—Å—Ç—å ~0.3 —Å–µ–∫.

## ‚ú® –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

- ‚ö° –ë–ª–∏—Å–∫–∞–≤–∏—á–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å (~0.3 —Å–µ–∫)
- üèóÔ∏è –ú–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∑ src/ layout
- üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤
- üìä –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤ OPC UA
- üîÑ –ó–≤–æ—Ä–æ—Ç–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ compatibility wrappers
- ‚úçÔ∏è –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —è–∫ —á–∏—Ç–∞–Ω–Ω—è, —Ç–∞–∫ —ñ –∑–∞–ø–∏—Å—É
- üß™ –ü–æ–≤–Ω–µ –ø–æ–∫—Ä–∏—Ç—Ç—è —Ç–µ—Å—Ç–∞–º–∏

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
pip install -e .

# –ê–±–æ –∞–∫—Ç–∏–≤–∞—Ü—ñ—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
source .venv/bin/activate
```

## üìö –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ß–∏—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö

#### –ü—Ä–∏–∫–ª–∞–¥ 1: Context Manager (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π)

```python
import asyncio
from src.opcua import OPCUAReader

async def main():
    async with OPCUAReader("opc.tcp://server:4840") as reader:
        # –ß–∏—Ç–∞–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –≤—É–∑–ª–∞
        data = await reader.read_node("cepn1")
        print(data)

asyncio.run(main())
```

#### –ü—Ä–∏–∫–ª–∞–¥ 2: –†—É—á–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º

```python
from src.opcua import OPCUAReader

async def main():
    reader = OPCUAReader("opc.tcp://server:4840")
    await reader.connect()

    data = await reader.read_node("valve1")
    print(data)

    await reader.disconnect()

asyncio.run(main())
```

#### –ü—Ä–∏–∫–ª–∞–¥ 3: –ß–∏—Ç–∞–Ω–Ω—è –≤—Å—ñ—Ö –≤—É–∑–ª—ñ–≤

```python
from src.opcua import OPCUAReader, format_output

async with OPCUAReader("opc.tcp://server:4840") as reader:
    all_data = await reader.read_all()

    # JSON —Ñ–æ—Ä–º–∞—Ç
    print(format_output(all_data, format_type="json"))

    # Tree —Ñ–æ—Ä–º–∞—Ç (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
    print(format_output(all_data, format_type="tree"))
```

### –ó–∞–ø–∏—Å –¥–∞–Ω–∏—Ö

#### –ü—Ä–∏–∫–ª–∞–¥ 1: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è OPCUAWriter –∫–ª–∞—Å—É (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π)

```python
from src.opcua import OPCUAWriter

async def main():
    data = {
        "cepn1.sensor1": 1,
        "cepn1.sensor2": 1,
        "cepn1.test": True,
    }

    async with OPCUAWriter("opc.tcp://server:4840") as writer:
        results = await writer.write(data)
        print(f"–ó–∞–ø–∏—Å–∞–Ω–æ: {sum(results.values())}/{len(results)}")

asyncio.run(main())
```

#### –ü—Ä–∏–∫–ª–∞–¥ 2: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó write_values

```python
from src.opcua import write_values
from asyncua import Client

async def main():
    data = {
        "cepn1.test": 1,
        "cepn1.frequency": 1500,
        "valve1.position": 50,
    }

    async with Client("opc.tcp://server:4840") as client:
        results = await write_values(client, data)

        for path, success in results.items():
            status = "‚úì" if success else "‚úó"
            print(f"{status} {path}")

asyncio.run(main())
```

#### –ü—Ä–∏–∫–ª–∞–¥ 3: –¶–∏–∫–ª —á–∏—Ç–∞–Ω–Ω—è-–∑–∞–ø–∏—Å-—á–∏—Ç–∞–Ω–Ω—è

```python
from src.opcua import OPCUAReader, OPCUAWriter

async def main():
    # –ß–∏—Ç–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    async with OPCUAReader("opc.tcp://server:4840") as reader:
        data_before = await reader.read_node("cepn1")
        print(f"–ü–µ—Ä–µ–¥: {data_before}")

    # –ó–∞–ø–∏—Å –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
    async with OPCUAWriter("opc.tcp://server:4840") as writer:
        await writer.write({"cepn1.test": 42})

    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø–∏—Å—É
    async with OPCUAReader("opc.tcp://server:4840") as reader:
        data_after = await reader.read_node("cepn1")
        print(f"–ü—ñ—Å–ª—è: {data_after}")

asyncio.run(main())
```

### –ó–≤–æ—Ä–æ—Ç–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å (deprecated)

–°—Ç–∞—Ä–∏–π API –≤—Å–µ —â–µ –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ compatibility wrappers:

```python
# –°—Ç–∞—Ä–∏–π —ñ–º–ø–æ—Ä—Ç (–∑ deprecation warning)
from opcua import OPCUAReader, TypeCache
from opcua_writer import write_values

# –ù–æ–≤–∏–π —ñ–º–ø–æ—Ä—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π)
from src.opcua import OPCUAReader, OPCUAWriter, TypeCache, write_values
```

## üîß API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### OPCUAReader

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
```python
reader = OPCUAReader(
    url: str,
    target_object: str = "ePAC:Project",
    timeout: float = 30.0
)
```

**–ú–µ—Ç–æ–¥–∏:**
- `await connect()` - –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
- `await disconnect()` - –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
- `await read_node(node_name: str)` - —á–∏—Ç–∞–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—É–∑–ª–∞
- `await read_all()` - —á–∏—Ç–∞–Ω–Ω—è –≤—Å—ñ—Ö –≤—É–∑–ª—ñ–≤
- `get_cache_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à—É

**Context Manager:**
```python
async with OPCUAReader(url) as reader:
    # –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
    data = await reader.read_node("cepn1")
```

### OPCUAWriter

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
```python
writer = OPCUAWriter(
    url: str,
    target_object: str = "ePAC:Project",
    timeout: float = 30.0
)
```

**–ú–µ—Ç–æ–¥–∏:**
- `await connect()` - –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
- `await disconnect()` - –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
- `await write(data: Dict[str, Any], auto_convert: bool = True)` - –∑–∞–ø–∏—Å –∑–Ω–∞—á–µ–Ω—å

**Context Manager:**
```python
async with OPCUAWriter(url) as writer:
    # –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
    results = await writer.write({"cepn1.test": 1})
```

### write_values()

```python
await write_values(
    client: Client,
    data: Dict[str, Any],
    root_object_name: Optional[str] = None,
    auto_convert: bool = True
) -> Dict[str, bool]
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `client` - OPC UA –∫–ª—ñ—î–Ω—Ç (–≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π)
- `data` - —Å–ª–æ–≤–Ω–∏–∫ `{—à–ª—è—Ö: –∑–Ω–∞—á–µ–Ω–Ω—è}`
- `root_object_name` - –∫–æ—Ä–µ–Ω–µ–≤–∏–π –æ–±'—î–∫—Ç (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º "ePAC:Project")
- `auto_convert` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —Ç–∏–ø—ñ–≤

**–ü–æ–≤–µ—Ä—Ç–∞—î:** —Å–ª–æ–≤–Ω–∏–∫ `{—à–ª—è—Ö: —É—Å–ø—ñ—Ö}`

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
opcua-turbo/
‚îú‚îÄ‚îÄ src/opcua/              # –ì–æ–ª–æ–≤–Ω–∏–π –ø–∞–∫–µ—Ç (–Ω–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py         # Public API
‚îÇ   ‚îú‚îÄ‚îÄ core/               # –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common.py       # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ —Ç–∞ —Ç–∏–ø–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache.py        # TypeCache –∑ LRU
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ type_conversion.py  # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —Ç–∏–ø—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ client/             # OPC UA –∫–ª—ñ—î–Ω—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reader.py       # OPCUAReader
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ writer.py       # OPCUAWriter
‚îÇ   ‚îú‚îÄ‚îÄ navigation/         # –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ –¥–µ—Ä–µ–≤—É
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ navigator.py    # –ü–æ—à—É–∫ –≤—É–∑–ª—ñ–≤
‚îÇ   ‚îî‚îÄ‚îÄ parsing/            # –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
‚îÇ       ‚îú‚îÄ‚îÄ parser.py       # –ü–∞—Ä—Å–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω—å
‚îÇ       ‚îî‚îÄ‚îÄ formatter.py    # JSON/Tree —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ opcua/                  # –°—Ç–∞—Ä–∏–π –ø–∞–∫–µ—Ç (compatibility wrapper)
‚îú‚îÄ‚îÄ tests/                  # –¢–µ—Å—Ç–∏ pytest
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py         # Fixtures
‚îÇ   ‚îî‚îÄ‚îÄ test_opcua.py       # –û—Å–Ω–æ–≤–Ω—ñ —Ç–µ—Å—Ç–∏
‚îú‚îÄ‚îÄ examples/               # –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
‚îÇ   ‚îú‚îÄ‚îÄ simple_reader.py    # –ü—Ä–æ—Å—Ç–∏–π Reader
‚îÇ   ‚îú‚îÄ‚îÄ simple_writer.py    # –ü—Ä–æ—Å—Ç–∏–π Writer
‚îÇ   ‚îî‚îÄ‚îÄ combined_operations.py  # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
‚îú‚îÄ‚îÄ docs/                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ README.md               # –¶–µ–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ USAGE.md                # –î–µ—Ç–∞–ª—å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
‚îî‚îÄ‚îÄ requirements.txt        # –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –∑ pytest

```bash
# –í—Å—ñ —Ç–µ—Å—Ç–∏
pytest tests/

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ç–µ—Å—Ç
pytest tests/test_opcua.py::test_reader_connect

# –ó verbose –≤–∏–≤–æ–¥–æ–º
pytest -v tests/

# –ó –ø–æ–∫—Ä–∏—Ç—Ç—è–º
pytest --cov=src/opcua tests/
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤ –±–µ–∑ pytest

```bash
python tests/test_opcua.py
```

## üìñ –ü—Ä–∏–∫–ª–∞–¥–∏

–î–∏–≤—ñ—Ç—å—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é `examples/` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–∏—Ö –ø—Ä–∏–∫–ª–∞–¥—ñ–≤:

```bash
# –ü—Ä–æ—Å—Ç–∏–π Reader
python examples/simple_reader.py

# –ü—Ä–æ—Å—Ç–∏–π Writer
python examples/simple_writer.py

# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
python examples/combined_operations.py
```

## üêõ –£—Å—É–Ω–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

**–û–±'—î–∫—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ**
```
‚ö† –û–±'—î–∫—Ç 'ePAC:Project' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
```
‚Üí –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–∑–≤—É –æ–±'—î–∫—Ç–∞ —á–µ—Ä–µ–∑ UaExpert –∞–±–æ –≤–∫–∞–∂—ñ—Ç—å —ñ–Ω—à–∏–π target_object

**–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è**
```
‚úó –ü–æ–º–∏–ª–∫–∞: Connection refused
```
‚Üí –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ URL —Å–µ—Ä–≤–µ—Ä–∞, —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π —Å–µ—Ä–≤–µ—Ä, firewall

**Import error (ModuleNotFoundError)**
```
ModuleNotFoundError: No module named 'asyncua'
```
‚Üí –ê–∫—Ç–∏–≤—É–π—Ç–µ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: `source .venv/bin/activate`

**Deprecation warnings**
```
DeprecationWarning: Importing from 'opcua' is deprecated
```
‚Üí –û–Ω–æ–≤—ñ—Ç—å —ñ–º–ø–æ—Ä—Ç–∏ –Ω–∞ `from src.opcua import ...`

## üì¶ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

- Python >= 3.8
- asyncua >= 1.1.0
- pytest >= 7.0.0 (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)
- pytest-asyncio >= 0.21.0 (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)

–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:
```bash
pip install -r requirements.txt
```

## üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è –∑ v2.0 –Ω–∞ v2.1

–°—Ç–∞—Ä–∏–π –∫–æ–¥ –ø—Ä–æ–¥–æ–≤–∂—É—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ compatibility wrappers:

```python
# v2.0 (–≤—Å–µ —â–µ –ø—Ä–∞—Ü—é—î, –∞–ª–µ deprecated)
from opcua import OPCUAReader
from opcua_writer import write_values

# v2.1 (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π)
from src.opcua import OPCUAReader, OPCUAWriter, write_values
```

–ó–º—ñ–Ω–∏:
- –î–æ–¥–∞–Ω–æ `OPCUAWriter` –∫–ª–∞—Å (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∏–π –¥–æ `OPCUAReader`)
- –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∫–æ–¥ –≤ `src/opcua/` —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –°—Ç–∞—Ä—ñ —ñ–º–ø–æ—Ä—Ç–∏ –ø—Ä–∞—Ü—é—é—Ç—å —á–µ—Ä–µ–∑ wrapper –∑ deprecation warning
- Compatibility wrappers –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –≤ v3.0

---

**–í–µ—Ä—Å—ñ—è**: 2.1.0
**–®–≤–∏–¥–∫—ñ—Å—Ç—å**: ~0.3 —Å–µ–∫
**–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞**: –ú–æ–¥—É–ª—å–Ω–∞ src/ layout
**Python**: >= 3.8
